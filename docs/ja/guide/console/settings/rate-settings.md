## コアコンセプト (Core Concepts)

| 日本語 | English | 説明 | Description |
|------|---------|------|-------------|
| 倍率 | Ratio | 価格計算に使用される乗数因子 | Multiplier factor used for price calculation |
| トークン | Token | APIアクセス認証情報、またはモデルが処理するテキスト単位 | API access credentials or text units processed by models |
| チャネル | Channel | APIサービスプロバイダーのアクセスチャネル | Access channel for API service providers |
| グループ | Group | ユーザーまたはトークンの分類。価格倍率に影響を与える | Classification of users or tokens, affecting price ratios |
| クォータ | Quota | ユーザーが利用可能なサービス割り当て量 | Available service quota for users |

# 倍率設定

倍率設定は NewAPI 課金システムの中核となる設定であり、異なる倍率を設定することで、様々なモデルやユーザーグループの課金基準を柔軟に制御できます。

## 倍率システムの概要

NewAPI は、ユーザーのクォータ消費を計算するために三層の倍率体系を使用します。

1. モデル倍率（ModelRatio） - 異なるAIモデルの基本課金倍数を定義
2. 補完倍率（CompletionRatio） - 出力トークンに追加の課金調整を行う
3. グループ倍率（GroupRatio） - 異なるユーザーグループに対して差別化された課金倍数を設定

### クォータと倍率の関係

New API システムにおいて、倍率はクォータ消費を計算するための重要なパラメータです。クォータはシステム内部の課金単位であり、すべてのAPI呼び出しは最終的にクォータポイントに変換されて差し引かれます。

クォータ単位の変換：

- 1 米ドル = 500,000 クォータポイント
- クォータポイントはシステム内部課金の基本単位です
- ユーザーの残高、消費履歴はすべてクォータポイントに基づきます

### クォータ計算式

#### 従量課金モデル（トークン消費に基づく）

```
配额消耗 = (输入token数 + 输出token数 × 补全倍率) × 模型倍率 × 分组倍率
```

#### 呼び出し回数課金モデル（固定価格）

```
配额消耗 = 模型固定价格 × 分组倍率 × 配额单位(500,000)
```

#### オーディオモデル（特殊処理、new-api内部で自動処理）

```
配额消耗 = (文本输入token + 文本输出token × 补全倍率 + 音频输入token × 音频倍率 + 音频输出token × 音频倍率 × 音频补全倍率) × 模型倍率 × 分组倍率
```

#### 事前消費と事後消費のメカニズム

New API は、事前消費と事後消費の二重課金メカニズムを採用しています。

1. **事前消費フェーズ**：API呼び出し前に、予測トークン数に基づいてクォータ消費を計算し、事前差し引きを行います
2. **事後消費フェーズ**：API呼び出し完了後、実際のトークン数に基づいてクォータ消費を再計算します
3. **差額調整**：実際の消費が事前消費と異なる場合、システムは自動的にユーザーのクォータ残高を調整します

```
预消费配额 = 预估token数 × 模型倍率 × 分组倍率
实际配额 = 实际token数 × 模型倍率 × 分组倍率
配额调整 = 实际配额 - 预消费配额
```

## モデル倍率設定

モデル倍率は、異なるAIモデルの基本課金倍数を定義します。システムは、様々なモデルに対してデフォルトの倍率を事前に設定しています。

### 一般的なモデル倍率の例

| モデル名称 | モデル倍率 | 補完倍率 | 公式価格（入力） | 公式価格（出力） |
|---------|---------|---------|---------|---------|
| gpt-4o | 1.25 | 4 | $2.5/1M Tokens | $10/1M Tokens |
| gpt-3.5-turbo | 0.25 | 1.33 | $0.5/1M Tokens | $1.5/1M Tokens |
| gpt-4o-mini | 0.075 | 4 | $0.15/1M Tokens | $0.6/1M Tokens |
| o1 | 7.5 | 4 | $15/1M Tokens | $60/1M Tokens |

倍率の意味の説明：

- モデル倍率：基本課金単位に対する倍数で、モデルのコスト差を反映
- 補完倍率：出力トークンが入力トークンに対して課金される倍数で、出力コストの差を反映
- 倍率が高いほど、消費されるクォータが多くなります。倍率が低いほど、消費されるクォータが少なくなります。

### 設定方法

1. JSON形式の設定：モデル倍率のJSON設定を直接編集
2. 可視化エディタ：グラフィカルインターフェースを通じて倍率を設定

![倍率1](../../../assets/guide/rate-setting-1.png)

## 補完倍率設定

補完倍率は、出力トークンに追加の課金を行うために使用され、主に異なるモデルの入出力コストの差を均衡させるために用いられます。

### デフォルトの補完倍率

| モデルタイプ | 公式価格（入力） | 公式価格（出力） | 補完倍率 | 説明 |
|---------|---------|------|------|------|
| gpt-4o | 2.5$/1M Tokens | 10$/1M Tokens | 4 | 出力は入力の4倍 |
| gpt-3.5-turbo | 0.5$/1M Tokens | 1$/1M Tokens | 2 | 出力は入力の2倍 |
| gpt-image-1 | 5$/1M Tokens | 40$/1M Tokens | 8 | 出力は入力の8倍 |
| gpt-4o-mini | 0.15$/1M Tokens | 0.6$/1M Tokens | 4 | 出力は入力の4倍 |
| その他モデル | 1 | 1 | 1 | 出力は入力の1倍 |

### 設定に関する説明

- 補完倍率は主に出力トークンの課金に影響します
- 1に設定すると、出力トークンの課金は入力トークンの課金と同じになります
- 1より大きい場合は出力トークンの課金が高くなり、1より小さい場合は出力トークンの課金が低くなります

## グループ倍率設定

グループ倍率により、異なるユーザーグループに対して差別化された課金倍数を設定し、柔軟な価格設定戦略を実現できます。

### グループ倍率の構成

```json
{
  "vip": 0.5,
  "premium": 0.8,
  "standard": 1.0,
  "trial": 2.0
}
```

### グループ倍率の優先順位

1. ユーザー専用倍率：特定のユーザーに設定された個人倍率
2. グループ倍率：ユーザーが所属するグループの倍率
3. デフォルト倍率：システムデフォルトの倍率（通常は1.0）

![倍率2](../../../assets/guide/rate-setting-2.png)

## 可視化された倍率設定

可視化エディタは、直感的な倍率管理インターフェースを提供し、以下をサポートします。

- モデル倍率の一括編集
- 倍率設定のリアルタイムプレビュー
- 競合検出とヒント
- アップストリーム倍率のワンクリック同期

![倍率3](../../../assets/guide/rate-setting-3.png)

## 倍率が設定されていないモデル

倍率が設定されていないモデルについて、システムは以下のように動作します。

1. 自社利用モード：デフォルト倍率37.5を使用
2. 商用モード：「倍率または価格が未設定」エラーを通知
3. 自動検出：管理インターフェースに未設定のモデルを表示

![倍率4](../../../assets/guide/rate-setting-4.png)

## アップストリーム倍率の同期

システムは、アップストリームチャネルからの倍率設定の自動同期をサポートしています。

- アップストリームモデル倍率の自動取得
- ローカル倍率設定の一括更新
- アップストリーム価格との同期維持
- 手動調整と上書きのサポート

![倍率5](../../../assets/guide/rate-setting-5.png)

## よくある質問

### Q: 新しいモデルの倍率を設定するにはどうすればよいですか？

A: 可視化エディタを通じて新しいモデルを追加するか、JSON設定に直接追加できます。まずは控えめな倍率を設定し、実際の使用状況に基づいて調整することをお勧めします。

### Q: グループ倍率はどのように有効になりますか？

A: グループ倍率はモデル倍率と乗算され、最終的にユーザーのクォータ消費計算に影響を与えます。ユーザーの実際の倍率 = モデル倍率 × グループ倍率です。

### Q: 補完倍率の役割は何ですか？

A: 補完倍率は、主に入力トークンと出力トークンのコスト差を均衡させるために使用されます。一部のモデルでは、出力コストが入力コストよりもはるかに高いため、補完倍率による調整が必要です。

### Q: 類似モデルの倍率を一括設定するにはどうすればよいですか？

A: 可視化エディタを通じて一括操作を行うか、JSON設定に類似モデルの倍率設定を一括で追加できます。

## クォータ計算の事例

### 事例1：GPT-4 標準ユーザーとの対話

シナリオパラメータ：

- 入力トークン：1,000
- 出力トークン：500
- モデル倍率：15
- 補完倍率：2
- グループ倍率：1.0（標準ユーザー）

計算プロセス：

```
配额消耗 = (1,000 + 500 × 2) × 15 × 1.0
         = (1,000 + 1,000) × 15
         = 2,000 × 15
         = 30,000 配额点数
```

等価ドルコスト：30,000 ÷ 500,000 = $0.06

### 事例2：GPT-3.5 VIPユーザーとの対話

シナリオパラメータ：

- 入力トークン：2,000
- 出力トークン：1,000
- モデル倍率：0.25
- 補完倍率：1.33
- グループ倍率：0.5（VIPユーザー50%割引）

計算プロセス：

```
配额消耗 = (2,000 + 1,000 × 1.33) × 0.25 × 0.5
         = (2,000 + 1,330) × 0.125
         = 3,330 × 0.125
         = 416.25 配额点数
```

等価ドルコスト：416.25 ÷ 500,000 = $0.00083

### 事例3：呼び出し回数課金モデル（例：Midjourney）

シナリオパラメータ：

- モデル固定価格：$0.02
- グループ倍率：1.0（標準ユーザー）
- クォータ単位：500,000

計算プロセス：

```
配额消耗 = 0.02 × 1.0 × 500,000
         = 10,000 配额点数
```

等価ドルコスト：10,000 ÷ 500,000 = $0.02

課金ルールに関する詳細については、[よくある質問](../support/faq.md)をご覧ください。